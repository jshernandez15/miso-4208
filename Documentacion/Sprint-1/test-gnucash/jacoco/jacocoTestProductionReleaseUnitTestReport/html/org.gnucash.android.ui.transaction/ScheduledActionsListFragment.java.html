<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScheduledActionsListFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.gnucash.android.ui.transaction</a> &gt; <span class="el_source">ScheduledActionsListFragment.java</span></div><h1>ScheduledActionsListFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2013 - 2015 Ngewi Fet &lt;ngewif@gmail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.gnucash.android.ui.transaction;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;
import android.database.Cursor;
import android.graphics.Rect;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.app.ListFragment;
import android.support.v4.app.LoaderManager;
import android.support.v4.content.Loader;
import android.support.v4.widget.SimpleCursorAdapter;
import android.support.v7.app.ActionBar;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.view.ActionMode;
import android.util.Log;
import android.util.SparseBooleanArray;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.TouchDelegate;
import android.view.View;
import android.view.ViewGroup;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import org.gnucash.android.R;
import org.gnucash.android.app.GnuCashApplication;
import org.gnucash.android.db.DatabaseCursorLoader;
import org.gnucash.android.db.DatabaseSchema;
import org.gnucash.android.db.adapter.ScheduledActionDbAdapter;
import org.gnucash.android.db.adapter.TransactionsDbAdapter;
import org.gnucash.android.export.ExportParams;
import org.gnucash.android.model.ScheduledAction;
import org.gnucash.android.model.Transaction;
import org.gnucash.android.ui.common.FormActivity;
import org.gnucash.android.ui.common.UxArgument;

import java.text.DateFormat;
import java.util.Date;
import java.util.List;

/**
 * Fragment which displays the scheduled actions in the system
 * &lt;p&gt;Currently, it handles the display of scheduled transactions and scheduled exports&lt;/p&gt;
 * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
 */
<span class="nc" id="L72">public class ScheduledActionsListFragment extends ListFragment implements</span>
        LoaderManager.LoaderCallbacks&lt;Cursor&gt; {

    /**
     * Logging tag
     */
    protected static final String TAG = &quot;ScheduledActionFragment&quot;;

    private TransactionsDbAdapter mTransactionsDbAdapter;
    private SimpleCursorAdapter mCursorAdapter;
<span class="nc" id="L82">    private ActionMode mActionMode = null;</span>

    /**
     * Flag which is set when a transaction is selected
     */
<span class="nc" id="L87">    private boolean mInEditMode = false;</span>

<span class="nc" id="L89">    private ScheduledAction.ActionType mActionType = ScheduledAction.ActionType.TRANSACTION;</span>

    /**
     * Callbacks for the menu items in the Context ActionBar (CAB) in action mode
     */
<span class="nc" id="L94">    private ActionMode.Callback mActionModeCallbacks = new ActionMode.Callback() {</span>

        @Override
        public boolean onCreateActionMode(ActionMode mode, Menu menu) {
<span class="nc" id="L98">            MenuInflater inflater = mode.getMenuInflater();</span>
<span class="nc" id="L99">            inflater.inflate(R.menu.schedxactions_context_menu, menu);</span>
<span class="nc" id="L100">            return true;</span>
        }

        @Override
        public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
            //nothing to see here, move along
<span class="nc" id="L106">            return false;</span>
        }

        @Override
        public void onDestroyActionMode(ActionMode mode) {
<span class="nc" id="L111">            finishEditMode();</span>
<span class="nc" id="L112">        }</span>

        @Override
        public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">            switch (item.getItemId()) {</span>
                case R.id.context_menu_delete:
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    for (long id : getListView().getCheckedItemIds()) {</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">                        if (mActionType == ScheduledAction.ActionType.TRANSACTION) {</span>
<span class="nc" id="L121">                            Log.i(TAG, &quot;Cancelling scheduled transaction(s)&quot;);</span>
<span class="nc" id="L122">                            String trnUID = mTransactionsDbAdapter.getUID(id);</span>
<span class="nc" id="L123">                            ScheduledActionDbAdapter scheduledActionDbAdapter = GnuCashApplication.getScheduledEventDbAdapter();</span>
<span class="nc" id="L124">                            List&lt;ScheduledAction&gt; actions = scheduledActionDbAdapter.getScheduledActionsWithUID(trnUID);</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">                            if (mTransactionsDbAdapter.deleteRecord(id)) {</span>
<span class="nc" id="L127">                                Toast.makeText(getActivity(),</span>
                                        R.string.toast_recurring_transaction_deleted,
<span class="nc" id="L129">                                        Toast.LENGTH_SHORT).show();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                                for (ScheduledAction action : actions) {</span>
<span class="nc" id="L131">                                    scheduledActionDbAdapter.deleteRecord(action.getUID());</span>
<span class="nc" id="L132">                                }</span>
                            }
<span class="nc bnc" id="L134" title="All 2 branches missed.">                        } else if (mActionType == ScheduledAction.ActionType.BACKUP){</span>
<span class="nc" id="L135">                            Log.i(TAG, &quot;Removing scheduled exports&quot;);</span>
<span class="nc" id="L136">                            ScheduledActionDbAdapter.getInstance().deleteRecord(id);</span>
                        }
                    }
<span class="nc" id="L139">                    mode.finish();</span>
<span class="nc" id="L140">                    setDefaultStatusBarColor();</span>
<span class="nc" id="L141">                    getLoaderManager().destroyLoader(0);</span>
<span class="nc" id="L142">                    refreshList();</span>
<span class="nc" id="L143">                    return true;</span>

                default:
<span class="nc" id="L146">                    setDefaultStatusBarColor();</span>
<span class="nc" id="L147">                    return false;</span>
            }
        }
    };

    private void setDefaultStatusBarColor() {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span class="nc" id="L154">            getActivity().getWindow().setStatusBarColor(getResources().getColor(R.color.theme_primary_dark));</span>
        }
<span class="nc" id="L156">    }</span>

    /**
     * Returns a new instance of the fragment for displayed the scheduled action
     * @param actionType Type of scheduled action to be displayed
     * @return New instance of fragment
     */
    public static Fragment getInstance(ScheduledAction.ActionType actionType){
<span class="nc" id="L164">        ScheduledActionsListFragment fragment = new ScheduledActionsListFragment();</span>
<span class="nc" id="L165">        fragment.mActionType = actionType;</span>
<span class="nc" id="L166">        return fragment;</span>
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L171">        super.onCreate(savedInstanceState);</span>

<span class="nc" id="L173">        mTransactionsDbAdapter = TransactionsDbAdapter.getInstance();</span>
<span class="nc bnc" id="L174" title="All 3 branches missed.">        switch (mActionType){</span>
            case TRANSACTION:
<span class="nc" id="L176">                mCursorAdapter = new ScheduledTransactionsCursorAdapter(</span>
<span class="nc" id="L177">                        getActivity().getApplicationContext(),</span>
                        R.layout.list_item_scheduled_trxn, null,
                        new String[] {DatabaseSchema.TransactionEntry.COLUMN_DESCRIPTION},
                        new int[] {R.id.primary_text});
<span class="nc" id="L181">                break;</span>
            case BACKUP:
<span class="nc" id="L183">                mCursorAdapter = new ScheduledExportCursorAdapter(</span>
<span class="nc" id="L184">                        getActivity().getApplicationContext(),</span>
                        R.layout.list_item_scheduled_trxn, null,
                        new String[]{}, new int[]{});
<span class="nc" id="L187">                break;</span>

            default:
<span class="nc" id="L190">                throw new IllegalArgumentException(&quot;Unable to display scheduled actions for the specified action type&quot;);</span>

        }

<span class="nc" id="L194">        setListAdapter(mCursorAdapter);</span>
<span class="nc" id="L195">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
<span class="nc" id="L200">        return inflater.inflate(R.layout.fragment_scheduled_events_list, container, false);</span>
    }

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L205">        super.onActivityCreated(savedInstanceState);</span>

<span class="nc" id="L207">        ActionBar actionBar = ((AppCompatActivity) getActivity()).getSupportActionBar();</span>
<span class="nc" id="L208">        actionBar.setDisplayShowTitleEnabled(true);</span>
<span class="nc" id="L209">        actionBar.setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L210">        actionBar.setHomeButtonEnabled(true);</span>

<span class="nc" id="L212">        setHasOptionsMenu(true);</span>
<span class="nc" id="L213">        getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE);</span>
<span class="nc" id="L214">        ((TextView)getListView().getEmptyView()).setTextColor(getResources().getColor(R.color.theme_accent));</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (mActionType == ScheduledAction.ActionType.TRANSACTION){</span>
<span class="nc" id="L216">            ((TextView)getListView().getEmptyView()).setText(R.string.label_no_recurring_transactions);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        } else if (mActionType == ScheduledAction.ActionType.BACKUP){</span>
<span class="nc" id="L218">            ((TextView)getListView().getEmptyView()).setText(R.string.label_no_scheduled_exports_to_display);</span>
        }
<span class="nc" id="L220">    }</span>

    /**
     * Reload the list of transactions and recompute account balances
     */
    public void refreshList(){
<span class="nc" id="L226">        getLoaderManager().restartLoader(0, null, this);</span>
<span class="nc" id="L227">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L231">        super.onResume();</span>
<span class="nc" id="L232">        refreshList();</span>
<span class="nc" id="L233">    }</span>


    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (mActionType == ScheduledAction.ActionType.BACKUP)</span>
<span class="nc" id="L239">            inflater.inflate(R.menu.scheduled_export_actions, menu);</span>
<span class="nc" id="L240">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        switch (item.getItemId()){</span>
            case R.id.menu_add_scheduled_export:
<span class="nc" id="L246">                Intent intent = new Intent(getActivity(), FormActivity.class);</span>
<span class="nc" id="L247">                intent.putExtra(UxArgument.FORM_TYPE, FormActivity.FormType.EXPORT.name());</span>
<span class="nc" id="L248">                startActivityForResult(intent, 0x1);</span>
<span class="nc" id="L249">                return true;</span>
            default:
<span class="nc" id="L251">                return super.onOptionsItemSelected(item);</span>
        }
    }

    @Override
    public void onListItemClick(ListView l, View v, int position, long id) {
<span class="nc" id="L257">        super.onListItemClick(l, v, position, id);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (mActionMode != null){</span>
<span class="nc" id="L259">            CheckBox checkbox = (CheckBox) v.findViewById(R.id.checkbox);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            checkbox.setChecked(!checkbox.isChecked());</span>
<span class="nc" id="L261">            return;</span>
        }

<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (mActionType == ScheduledAction.ActionType.BACKUP) //nothing to do for export actions</span>
<span class="nc" id="L265">            return;</span>

<span class="nc" id="L267">        Transaction transaction = mTransactionsDbAdapter.getRecord(id);</span>

        //this should actually never happen, but has happened once. So perform check for the future
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (transaction.getSplits().size() == 0){</span>
<span class="nc" id="L271">            Toast.makeText(getActivity(), R.string.toast_transaction_has_no_splits_and_cannot_open, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L272">            return;</span>
        }

<span class="nc" id="L275">        String accountUID = transaction.getSplits().get(0).getAccountUID();</span>
<span class="nc" id="L276">        openTransactionForEdit(accountUID, mTransactionsDbAdapter.getUID(id),</span>
<span class="nc" id="L277">                v.getTag().toString());</span>
<span class="nc" id="L278">    }</span>

    /**
     * Opens the transaction editor to enable editing of the transaction
     * @param accountUID GUID of account to which transaction belongs
     * @param transactionUID GUID of transaction to be edited
     */
    public void openTransactionForEdit(String accountUID, String transactionUID, String scheduledActionUid){
<span class="nc" id="L286">        Intent createTransactionIntent = new Intent(getActivity(), FormActivity.class);</span>
<span class="nc" id="L287">        createTransactionIntent.setAction(Intent.ACTION_INSERT_OR_EDIT);</span>
<span class="nc" id="L288">        createTransactionIntent.putExtra(UxArgument.FORM_TYPE, FormActivity.FormType.TRANSACTION.name());</span>
<span class="nc" id="L289">        createTransactionIntent.putExtra(UxArgument.SELECTED_ACCOUNT_UID, accountUID);</span>
<span class="nc" id="L290">        createTransactionIntent.putExtra(UxArgument.SELECTED_TRANSACTION_UID, transactionUID);</span>
<span class="nc" id="L291">        createTransactionIntent.putExtra(UxArgument.SCHEDULED_ACTION_UID, scheduledActionUid);</span>
<span class="nc" id="L292">        startActivity(createTransactionIntent);</span>
<span class="nc" id="L293">    }</span>

    @Override
    public Loader&lt;Cursor&gt; onCreateLoader(int arg0, Bundle arg1) {
<span class="nc" id="L297">        Log.d(TAG, &quot;Creating transactions loader&quot;);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (mActionType == ScheduledAction.ActionType.TRANSACTION)</span>
<span class="nc" id="L299">            return new ScheduledTransactionsCursorLoader(getActivity());</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        else if (mActionType == ScheduledAction.ActionType.BACKUP){</span>
<span class="nc" id="L301">            return new ScheduledExportCursorLoader(getActivity());</span>
        }
<span class="nc" id="L303">        return null;</span>
    }

    @Override
    public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor cursor) {
<span class="nc" id="L308">        Log.d(TAG, &quot;Transactions loader finished. Swapping in cursor&quot;);</span>
<span class="nc" id="L309">        mCursorAdapter.swapCursor(cursor);</span>
<span class="nc" id="L310">        mCursorAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L311">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc" id="L315">        Log.d(TAG, &quot;Resetting transactions loader&quot;);</span>
<span class="nc" id="L316">        mCursorAdapter.swapCursor(null);</span>
<span class="nc" id="L317">    }</span>

    /**
     * Finishes the edit mode in the transactions list.
     * Edit mode is started when at least one transaction is selected
     */
    public void finishEditMode(){
<span class="nc" id="L324">        mInEditMode = false;</span>
<span class="nc" id="L325">        uncheckAllItems();</span>
<span class="nc" id="L326">        mActionMode = null;</span>
<span class="nc" id="L327">    }</span>

    /**
     * Sets the title of the Context ActionBar when in action mode.
     * It sets the number highlighted items
     */
    public void setActionModeTitle(){
<span class="nc" id="L334">        int count = getListView().getCheckedItemIds().length; //mSelectedIds.size();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (count &gt; 0){</span>
<span class="nc" id="L336">            mActionMode.setTitle(getResources().getString(R.string.title_selected, count));</span>
        }
<span class="nc" id="L338">    }</span>

    /**
     * Unchecks all the checked items in the list
     */
    private void uncheckAllItems() {
<span class="nc" id="L344">        SparseBooleanArray checkedPositions = getListView().getCheckedItemPositions();</span>
<span class="nc" id="L345">        ListView listView = getListView();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        for (int i = 0; i &lt; checkedPositions.size(); i++) {</span>
<span class="nc" id="L347">            int position = checkedPositions.keyAt(i);</span>
<span class="nc" id="L348">            listView.setItemChecked(position, false);</span>
        }
<span class="nc" id="L350">    }</span>


    /**
     * Starts action mode and activates the Context ActionBar (CAB)
     * Action mode is initiated as soon as at least one transaction is selected (highlighted)
     */
    private void startActionMode(){
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (mActionMode != null) {</span>
<span class="nc" id="L359">            return;</span>
        }
<span class="nc" id="L361">        mInEditMode = true;</span>
        // Start the CAB using the ActionMode.Callback defined above
<span class="nc" id="L363">        mActionMode = ((AppCompatActivity) getActivity())</span>
<span class="nc" id="L364">                .startSupportActionMode(mActionModeCallbacks);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP){</span>
<span class="nc" id="L366">            getActivity().getWindow().setStatusBarColor(getResources().getColor(android.R.color.darker_gray));</span>
        }
<span class="nc" id="L368">    }</span>

    /**
     * Stops action mode and deselects all selected transactions.
     * This method only has effect if the number of checked items is greater than 0 and {@link #mActionMode} is not null
     */
    private void stopActionMode(){
<span class="nc" id="L375">        int checkedCount = getListView().getCheckedItemIds().length;</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">        if (checkedCount &lt;= 0 &amp;&amp; mActionMode != null) {</span>
<span class="nc" id="L377">            mActionMode.finish();</span>
<span class="nc" id="L378">            setDefaultStatusBarColor();</span>
        }
<span class="nc" id="L380">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc" id="L385">            refreshList();</span>
<span class="nc" id="L386">            super.onActivityResult(requestCode, resultCode, data);</span>
        }
<span class="nc" id="L388">    }</span>

    /**
     * Extends a simple cursor adapter to bind transaction attributes to views
     * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
     */
    protected class ScheduledTransactionsCursorAdapter extends SimpleCursorAdapter {

        public ScheduledTransactionsCursorAdapter(Context context, int layout, Cursor c,
<span class="nc" id="L397">                                                  String[] from, int[] to) {</span>
<span class="nc" id="L398">            super(context, layout, c, from, to, 0);</span>
<span class="nc" id="L399">        }</span>

        @Override
        public View getView(int position, View convertView, ViewGroup parent) {
<span class="nc" id="L403">            final View view = super.getView(position, convertView, parent);</span>
<span class="nc" id="L404">            final int itemPosition = position;</span>
<span class="nc" id="L405">            CheckBox checkbox = (CheckBox) view.findViewById(R.id.checkbox);</span>
            //TODO: Revisit this if we ever change the application theme
<span class="nc" id="L407">            int id = Resources.getSystem().getIdentifier(&quot;btn_check_holo_light&quot;, &quot;drawable&quot;, &quot;android&quot;);</span>
<span class="nc" id="L408">            checkbox.setButtonDrawable(id);</span>

<span class="nc" id="L410">            final TextView secondaryText = (TextView) view.findViewById(R.id.secondary_text);</span>

<span class="nc" id="L412">            checkbox.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {</span>

                @Override
                public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
<span class="nc" id="L416">                    getListView().setItemChecked(itemPosition, isChecked);</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                    if (isChecked) {</span>
<span class="nc" id="L418">                        startActionMode();</span>
                    } else {
<span class="nc" id="L420">                        stopActionMode();</span>
                    }
<span class="nc" id="L422">                    setActionModeTitle();</span>
<span class="nc" id="L423">                }</span>
            });


<span class="nc" id="L427">            ListView listView = (ListView) parent;</span>
<span class="nc bnc" id="L428" title="All 4 branches missed.">            if (mInEditMode &amp;&amp; listView.isItemChecked(position)){</span>
<span class="nc" id="L429">                view.setBackgroundColor(getResources().getColor(R.color.abs__holo_blue_light));</span>
<span class="nc" id="L430">                secondaryText.setTextColor(getResources().getColor(android.R.color.white));</span>
            } else {
<span class="nc" id="L432">                view.setBackgroundColor(getResources().getColor(android.R.color.transparent));</span>
<span class="nc" id="L433">                secondaryText.setTextColor(getResources().getColor(android.R.color.secondary_text_light_nodisable));</span>
<span class="nc" id="L434">                checkbox.setChecked(false);</span>
            }

<span class="nc" id="L437">            final View checkBoxView = checkbox;</span>
<span class="nc" id="L438">            final View parentView = view;</span>
<span class="nc" id="L439">            parentView.post(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc bnc" id="L442" title="All 2 branches missed.">                    if (isAdded()){ //may be run when fragment has been unbound from activity</span>
<span class="nc" id="L443">                        float extraPadding = getResources().getDimension(R.dimen.edge_padding);</span>
<span class="nc" id="L444">                        final android.graphics.Rect hitRect = new Rect();</span>
<span class="nc" id="L445">                        checkBoxView.getHitRect(hitRect);</span>
<span class="nc" id="L446">                        hitRect.right   += extraPadding;</span>
<span class="nc" id="L447">                        hitRect.bottom  += 3*extraPadding;</span>
<span class="nc" id="L448">                        hitRect.top     -= extraPadding;</span>
<span class="nc" id="L449">                        hitRect.left    -= 2*extraPadding;</span>
<span class="nc" id="L450">                        parentView.setTouchDelegate(new TouchDelegate(hitRect, checkBoxView));</span>
                    }
<span class="nc" id="L452">                }</span>
            });

<span class="nc" id="L455">            return view;</span>
        }

        @Override
        public void bindView(View view, Context context, Cursor cursor) {
<span class="nc" id="L460">            super.bindView(view, context, cursor);</span>

<span class="nc" id="L462">            Transaction transaction = mTransactionsDbAdapter.buildModelInstance(cursor);</span>

<span class="nc" id="L464">            TextView amountTextView = (TextView) view.findViewById(R.id.right_text);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">            if (transaction.getSplits().size() == 2){</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">                if (transaction.getSplits().get(0).isPairOf(transaction.getSplits().get(1))){</span>
<span class="nc" id="L467">                    amountTextView.setText(transaction.getSplits().get(0).getValue().formattedString());</span>
                }
            } else {
<span class="nc" id="L470">                amountTextView.setText(getString(R.string.label_split_count, transaction.getSplits().size()));</span>
            }
<span class="nc" id="L472">            TextView descriptionTextView = (TextView) view.findViewById(R.id.secondary_text);</span>

<span class="nc" id="L474">            ScheduledActionDbAdapter scheduledActionDbAdapter = ScheduledActionDbAdapter.getInstance();</span>
<span class="nc" id="L475">            String scheduledActionUID = cursor.getString(cursor.getColumnIndexOrThrow(&quot;origin_scheduled_action_uid&quot;)); //column created from join when fetching scheduled transactions</span>
<span class="nc" id="L476">            view.setTag(scheduledActionUID);</span>
<span class="nc" id="L477">            ScheduledAction scheduledAction = scheduledActionDbAdapter.getRecord(scheduledActionUID);</span>
<span class="nc" id="L478">            long endTime = scheduledAction.getEndTime();</span>
<span class="nc bnc" id="L479" title="All 4 branches missed.">            if (endTime &gt; 0 &amp;&amp; endTime &lt; System.currentTimeMillis()){</span>
<span class="nc" id="L480">                ((TextView)view.findViewById(R.id.primary_text)).setTextColor(getResources().getColor(android.R.color.darker_gray));</span>
<span class="nc" id="L481">                descriptionTextView.setText(getString(R.string.label_scheduled_action_ended,</span>
<span class="nc" id="L482">                        DateFormat.getInstance().format(new Date(scheduledAction.getLastRunTime()))));</span>
            } else {
<span class="nc" id="L484">                descriptionTextView.setText(scheduledAction.getRepeatString());</span>
            }
<span class="nc" id="L486">        }</span>
    }

    /**
     * Extends a simple cursor adapter to bind transaction attributes to views
     * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
     */
    protected class ScheduledExportCursorAdapter extends SimpleCursorAdapter {

        public ScheduledExportCursorAdapter(Context context, int layout, Cursor c,
<span class="nc" id="L496">                                            String[] from, int[] to) {</span>
<span class="nc" id="L497">            super(context, layout, c, from, to, 0);</span>
<span class="nc" id="L498">        }</span>

        @Override
        public View getView(int position, View convertView, ViewGroup parent) {
<span class="nc" id="L502">            final View view = super.getView(position, convertView, parent);</span>
<span class="nc" id="L503">            final int itemPosition = position;</span>
<span class="nc" id="L504">            CheckBox checkbox = (CheckBox) view.findViewById(R.id.checkbox);</span>
            //TODO: Revisit this if we ever change the application theme
<span class="nc" id="L506">            int id = Resources.getSystem().getIdentifier(&quot;btn_check_holo_light&quot;, &quot;drawable&quot;, &quot;android&quot;);</span>
<span class="nc" id="L507">            checkbox.setButtonDrawable(id);</span>

<span class="nc" id="L509">            final TextView secondaryText = (TextView) view.findViewById(R.id.secondary_text);</span>

<span class="nc" id="L511">            checkbox.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {</span>

                @Override
                public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
<span class="nc" id="L515">                    getListView().setItemChecked(itemPosition, isChecked);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                    if (isChecked) {</span>
<span class="nc" id="L517">                        startActionMode();</span>
                    } else {
<span class="nc" id="L519">                        stopActionMode();</span>
                    }
<span class="nc" id="L521">                    setActionModeTitle();</span>
<span class="nc" id="L522">                }</span>
            });


<span class="nc" id="L526">            ListView listView = (ListView) parent;</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">            if (mInEditMode &amp;&amp; listView.isItemChecked(position)){</span>
<span class="nc" id="L528">                view.setBackgroundColor(getResources().getColor(R.color.abs__holo_blue_light));</span>
<span class="nc" id="L529">                secondaryText.setTextColor(getResources().getColor(android.R.color.white));</span>
            } else {
<span class="nc" id="L531">                view.setBackgroundColor(getResources().getColor(android.R.color.transparent));</span>
<span class="nc" id="L532">                secondaryText.setTextColor(getResources().getColor(android.R.color.secondary_text_light_nodisable));</span>
<span class="nc" id="L533">                checkbox.setChecked(false);</span>
            }

<span class="nc" id="L536">            final View checkBoxView = checkbox;</span>
<span class="nc" id="L537">            final View parentView = view;</span>
<span class="nc" id="L538">            parentView.post(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc bnc" id="L541" title="All 2 branches missed.">                    if (isAdded()){ //may be run when fragment has been unbound from activity</span>
<span class="nc" id="L542">                        float extraPadding = getResources().getDimension(R.dimen.edge_padding);</span>
<span class="nc" id="L543">                        final android.graphics.Rect hitRect = new Rect();</span>
<span class="nc" id="L544">                        checkBoxView.getHitRect(hitRect);</span>
<span class="nc" id="L545">                        hitRect.right   += extraPadding;</span>
<span class="nc" id="L546">                        hitRect.bottom  += 3*extraPadding;</span>
<span class="nc" id="L547">                        hitRect.top     -= extraPadding;</span>
<span class="nc" id="L548">                        hitRect.left    -= 2*extraPadding;</span>
<span class="nc" id="L549">                        parentView.setTouchDelegate(new TouchDelegate(hitRect, checkBoxView));</span>
                    }
<span class="nc" id="L551">                }</span>
            });

<span class="nc" id="L554">            return view;</span>
        }

        @Override
        public void bindView(View view, Context context, Cursor cursor) {
<span class="nc" id="L559">            super.bindView(view, context, cursor);</span>
<span class="nc" id="L560">            ScheduledActionDbAdapter mScheduledActionDbAdapter = ScheduledActionDbAdapter.getInstance();</span>
<span class="nc" id="L561">            ScheduledAction scheduledAction = mScheduledActionDbAdapter.buildModelInstance(cursor);</span>

<span class="nc" id="L563">            TextView primaryTextView = (TextView) view.findViewById(R.id.primary_text);</span>
<span class="nc" id="L564">            ExportParams params = ExportParams.parseCsv(scheduledAction.getTag());</span>
<span class="nc" id="L565">            String exportDestination = params.getExportTarget().getDescription();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">            if (params.getExportTarget() == ExportParams.ExportTarget.URI){</span>
<span class="nc" id="L567">                exportDestination = exportDestination + &quot; (&quot; + Uri.parse(params.getExportLocation()).getHost() + &quot;)&quot;;</span>
            }
<span class="nc" id="L569">            primaryTextView.setText(params.getExportFormat().name() + &quot; &quot;</span>
<span class="nc" id="L570">                    + scheduledAction.getActionType().name().toLowerCase() + &quot; to &quot;</span>
                    + exportDestination);

<span class="nc" id="L573">            view.findViewById(R.id.right_text).setVisibility(View.GONE);</span>

<span class="nc" id="L575">            TextView descriptionTextView = (TextView) view.findViewById(R.id.secondary_text);</span>
<span class="nc" id="L576">            descriptionTextView.setText(scheduledAction.getRepeatString());</span>
<span class="nc" id="L577">            long endTime = scheduledAction.getEndTime();</span>
<span class="nc bnc" id="L578" title="All 4 branches missed.">            if (endTime &gt; 0 &amp;&amp; endTime &lt; System.currentTimeMillis()){</span>
<span class="nc" id="L579">                ((TextView)view.findViewById(R.id.primary_text)).setTextColor(getResources().getColor(android.R.color.darker_gray));</span>
<span class="nc" id="L580">                descriptionTextView.setText(getString(R.string.label_scheduled_action_ended,</span>
<span class="nc" id="L581">                        DateFormat.getInstance().format(new Date(scheduledAction.getLastRunTime()))));</span>
            } else {
<span class="nc" id="L583">                descriptionTextView.setText(scheduledAction.getRepeatString());</span>
            }
<span class="nc" id="L585">        }</span>
    }


    /**
     * {@link DatabaseCursorLoader} for loading recurring transactions asynchronously from the database
     * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
     */
    protected static class ScheduledTransactionsCursorLoader extends DatabaseCursorLoader {

        public ScheduledTransactionsCursorLoader(Context context) {
<span class="nc" id="L596">            super(context);</span>
<span class="nc" id="L597">        }</span>

        @Override
        public Cursor loadInBackground() {
<span class="nc" id="L601">            mDatabaseAdapter = TransactionsDbAdapter.getInstance();</span>

<span class="nc" id="L603">            Cursor c = ((TransactionsDbAdapter) mDatabaseAdapter).fetchAllScheduledTransactions();</span>

<span class="nc" id="L605">            registerContentObserver(c);</span>
<span class="nc" id="L606">            return c;</span>
        }
    }

    /**
     * {@link DatabaseCursorLoader} for loading recurring transactions asynchronously from the database
     * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
     */
    protected static class ScheduledExportCursorLoader extends DatabaseCursorLoader {

        public ScheduledExportCursorLoader(Context context) {
<span class="nc" id="L617">            super(context);</span>
<span class="nc" id="L618">        }</span>

        @Override
        public Cursor loadInBackground() {
<span class="nc" id="L622">            mDatabaseAdapter = ScheduledActionDbAdapter.getInstance();</span>

<span class="nc" id="L624">            Cursor c = mDatabaseAdapter.fetchAllRecords(</span>
                    DatabaseSchema.ScheduledActionEntry.COLUMN_TYPE + &quot;=?&quot;,
<span class="nc" id="L626">                    new String[]{ScheduledAction.ActionType.BACKUP.name()}, null);</span>

<span class="nc" id="L628">            registerContentObserver(c);</span>
<span class="nc" id="L629">            return c;</span>
        }
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountsActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.gnucash.android.ui.account</a> &gt; <span class="el_source">AccountsActivity.java</span></div><h1>AccountsActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012 - 2014 Ngewi Fet &lt;ngewif@gmail.com&gt;
 * Copyright (c) 2014 Yongxin Wang &lt;fefe.wyx@gmail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.gnucash.android.ui.account;

import android.Manifest;
import android.annotation.TargetApi;
import android.app.Activity;
import android.app.AlertDialog;
import android.content.ActivityNotFoundException;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.content.pm.PackageManager.NameNotFoundException;
import android.content.res.Resources;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.support.design.widget.CoordinatorLayout;
import android.support.design.widget.FloatingActionButton;
import android.support.design.widget.Snackbar;
import android.support.design.widget.TabLayout;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentPagerAdapter;
import android.support.v4.view.ViewPager;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.preference.PreferenceManager;
import android.util.Log;
import android.util.SparseArray;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Toast;

import com.crashlytics.android.Crashlytics;
import com.kobakei.ratethisapp.RateThisApp;

import org.gnucash.android.BuildConfig;
import org.gnucash.android.R;
import org.gnucash.android.app.GnuCashApplication;
import org.gnucash.android.db.DatabaseSchema;
import org.gnucash.android.db.adapter.AccountsDbAdapter;
import org.gnucash.android.db.adapter.BooksDbAdapter;
import org.gnucash.android.export.xml.GncXmlExporter;
import org.gnucash.android.importer.ImportAsyncTask;
import org.gnucash.android.ui.common.BaseDrawerActivity;
import org.gnucash.android.ui.common.FormActivity;
import org.gnucash.android.ui.common.Refreshable;
import org.gnucash.android.ui.common.UxArgument;
import org.gnucash.android.ui.transaction.TransactionsActivity;
import org.gnucash.android.ui.util.TaskDelegate;
import org.gnucash.android.ui.wizard.FirstRunWizardActivity;

import butterknife.BindView;

/**
 * Manages actions related to accounts, displaying, exporting and creating new accounts
 * The various actions are implemented as Fragments which are then added to this activity
 *
 * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
 * @author Oleksandr Tyshkovets &lt;olexandr.tyshkovets@gmail.com&gt;
 */
<span class="nc" id="L84">public class AccountsActivity extends BaseDrawerActivity implements OnAccountClickedListener {</span>

    /**
     * Request code for GnuCash account structure file to import
     */
    public static final int REQUEST_PICK_ACCOUNTS_FILE = 0x1;

    /**
     * Request code for opening the account to edit
     */
    public static final int REQUEST_EDIT_ACCOUNT = 0x10;

    /**
	 * Logging tag
	 */
	protected static final String LOG_TAG = &quot;AccountsActivity&quot;;

    /**
     * Number of pages to show
     */
    private static final int DEFAULT_NUM_PAGES = 3;

    /**
     * Index for the recent accounts tab
     */
    public static final int INDEX_RECENT_ACCOUNTS_FRAGMENT = 0;

    /**
     * Index of the top level (all) accounts tab
     */
    public static final int INDEX_TOP_LEVEL_ACCOUNTS_FRAGMENT = 1;

    /**
     * Index of the favorite accounts tab
     */
    public static final int INDEX_FAVORITE_ACCOUNTS_FRAGMENT = 2;

    /**
     * Used to save the index of the last open tab and restore the pager to that index
     */
    public static final String LAST_OPEN_TAB_INDEX = &quot;last_open_tab&quot;;

    /**
     * Key for putting argument for tab into bundle arguments
     */
    public static final String EXTRA_TAB_INDEX = &quot;org.gnucash.android.extra.TAB_INDEX&quot;;

    /**
     * Map containing fragments for the different tabs
     */
<span class="nc" id="L134">    private SparseArray&lt;Refreshable&gt; mFragmentPageReferenceMap = new SparseArray&lt;&gt;();</span>

    /**
     * ViewPager which manages the different tabs
     */
    @BindView(R.id.pager) ViewPager mViewPager;
    @BindView(R.id.fab_create_account) FloatingActionButton mFloatingActionButton;
    @BindView(R.id.coordinatorLayout) CoordinatorLayout mCoordinatorLayout;

    /**
     * Configuration for rating the app
     */
<span class="nc" id="L146">    public static RateThisApp.Config rateAppConfig = new RateThisApp.Config(14, 100);</span>
    private AccountViewPagerAdapter mPagerAdapter;

    /**
     * Adapter for managing the sub-account and transaction fragment pages in the accounts view
     */
    private class AccountViewPagerAdapter extends FragmentPagerAdapter {

<span class="nc" id="L154">        public AccountViewPagerAdapter(FragmentManager fm){</span>
<span class="nc" id="L155">            super(fm);</span>
<span class="nc" id="L156">        }</span>

        @Override
        public Fragment getItem(int i) {
<span class="nc" id="L160">            AccountsListFragment currentFragment = (AccountsListFragment) mFragmentPageReferenceMap.get(i);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (currentFragment == null) {</span>
<span class="nc bnc" id="L162" title="All 3 branches missed.">                switch (i) {</span>
                    case INDEX_RECENT_ACCOUNTS_FRAGMENT:
<span class="nc" id="L164">                        currentFragment = AccountsListFragment.newInstance(AccountsListFragment.DisplayMode.RECENT);</span>
<span class="nc" id="L165">                        break;</span>

                    case INDEX_FAVORITE_ACCOUNTS_FRAGMENT:
<span class="nc" id="L168">                        currentFragment = AccountsListFragment.newInstance(AccountsListFragment.DisplayMode.FAVORITES);</span>
<span class="nc" id="L169">                        break;</span>

                    case INDEX_TOP_LEVEL_ACCOUNTS_FRAGMENT:
                    default:
<span class="nc" id="L173">                        currentFragment = AccountsListFragment.newInstance(AccountsListFragment.DisplayMode.TOP_LEVEL);</span>
                        break;
                }
<span class="nc" id="L176">                mFragmentPageReferenceMap.put(i, currentFragment);</span>
            }
<span class="nc" id="L178">            return currentFragment;</span>
        }

        @Override
        public void destroyItem(ViewGroup container, int position, Object object) {
<span class="nc" id="L183">            super.destroyItem(container, position, object);</span>
<span class="nc" id="L184">            mFragmentPageReferenceMap.remove(position);</span>
<span class="nc" id="L185">        }</span>

        @Override
        public CharSequence getPageTitle(int position) {
<span class="nc bnc" id="L189" title="All 3 branches missed.">            switch (position){</span>
                case INDEX_RECENT_ACCOUNTS_FRAGMENT:
<span class="nc" id="L191">                    return getString(R.string.title_recent_accounts);</span>

                case INDEX_FAVORITE_ACCOUNTS_FRAGMENT:
<span class="nc" id="L194">                    return getString(R.string.title_favorite_accounts);</span>

                case INDEX_TOP_LEVEL_ACCOUNTS_FRAGMENT:
                default:
<span class="nc" id="L198">                    return getString(R.string.title_all_accounts);</span>
            }
        }

        @Override
        public int getCount() {
<span class="nc" id="L204">            return DEFAULT_NUM_PAGES;</span>
        }
    }

    public AccountsListFragment getCurrentAccountListFragment(){
<span class="nc" id="L209">        int index = mViewPager.getCurrentItem();</span>
<span class="nc" id="L210">        Fragment fragment = (Fragment) mFragmentPageReferenceMap.get(index);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (fragment == null)</span>
<span class="nc" id="L212">            fragment = mPagerAdapter.getItem(index);</span>
<span class="nc" id="L213">        return (AccountsListFragment) fragment;</span>
    }

    @Override
    public int getContentView() {
<span class="nc" id="L218">        return R.layout.activity_accounts;</span>
    }

    @Override
    public int getTitleRes() {
<span class="nc" id="L223">        return R.string.title_accounts;</span>
    }

    @Override
	public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L228">        super.onCreate(savedInstanceState);</span>

<span class="nc" id="L230">        final Intent intent = getIntent();</span>
<span class="nc" id="L231">        handleOpenFileIntent(intent);</span>

<span class="nc" id="L233">        init();</span>

<span class="nc" id="L235">        TabLayout tabLayout = (TabLayout) findViewById(R.id.tab_layout);</span>
<span class="nc" id="L236">        tabLayout.addTab(tabLayout.newTab().setText(R.string.title_recent_accounts));</span>
<span class="nc" id="L237">        tabLayout.addTab(tabLayout.newTab().setText(R.string.title_all_accounts));</span>
<span class="nc" id="L238">        tabLayout.addTab(tabLayout.newTab().setText(R.string.title_favorite_accounts));</span>
<span class="nc" id="L239">        tabLayout.setTabGravity(TabLayout.GRAVITY_FILL);</span>

        //show the simple accounts list
<span class="nc" id="L242">        mPagerAdapter = new AccountViewPagerAdapter(getSupportFragmentManager());</span>
<span class="nc" id="L243">        mViewPager.setAdapter(mPagerAdapter);</span>

<span class="nc" id="L245">        mViewPager.addOnPageChangeListener(new TabLayout.TabLayoutOnPageChangeListener(tabLayout));</span>
<span class="nc" id="L246">        tabLayout.setOnTabSelectedListener(new TabLayout.OnTabSelectedListener() {</span>
            @Override
            public void onTabSelected(TabLayout.Tab tab) {
<span class="nc" id="L249">                mViewPager.setCurrentItem(tab.getPosition());</span>
<span class="nc" id="L250">            }</span>

            @Override
            public void onTabUnselected(TabLayout.Tab tab) {
                //nothing to see here, move along
<span class="nc" id="L255">            }</span>

            @Override
            public void onTabReselected(TabLayout.Tab tab) {
                //nothing to see here, move along
<span class="nc" id="L260">            }</span>
        });

<span class="nc" id="L263">        setCurrentTab();</span>

<span class="nc" id="L265">        mFloatingActionButton.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L268">                Intent addAccountIntent = new Intent(AccountsActivity.this, FormActivity.class);</span>
<span class="nc" id="L269">                addAccountIntent.setAction(Intent.ACTION_INSERT_OR_EDIT);</span>
<span class="nc" id="L270">                addAccountIntent.putExtra(UxArgument.FORM_TYPE, FormActivity.FormType.ACCOUNT.name());</span>
<span class="nc" id="L271">                startActivityForResult(addAccountIntent, AccountsActivity.REQUEST_EDIT_ACCOUNT);</span>
<span class="nc" id="L272">            }</span>
        });
<span class="nc" id="L274">	}</span>

    @Override
    protected void onStart() {
<span class="nc" id="L278">        super.onStart();</span>

        if (BuildConfig.CAN_REQUEST_RATING) {
<span class="nc" id="L281">            RateThisApp.init(rateAppConfig);</span>
<span class="nc" id="L282">            RateThisApp.onStart(this);</span>
<span class="nc" id="L283">            RateThisApp.showRateDialogIfNeeded(this);</span>
        }
<span class="nc" id="L285">    }</span>

    /**
     * Handles the case where another application has selected to open a (.gnucash or .gnca) file with this app
     * @param intent Intent containing the data to be imported
     */
    private void handleOpenFileIntent(Intent intent) {
        //when someone launches the app to view a (.gnucash or .gnca) file
<span class="nc" id="L293">        Uri data = intent.getData();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (data != null){</span>
<span class="nc" id="L295">            GncXmlExporter.createBackup();</span>
<span class="nc" id="L296">            intent.setData(null);</span>
<span class="nc" id="L297">            new ImportAsyncTask(this).execute(data);</span>
<span class="nc" id="L298">            removeFirstRunFlag();</span>
        }
<span class="nc" id="L300">    }</span>

    @Override
    protected void onNewIntent(Intent intent) {
<span class="nc" id="L304">        super.onNewIntent(intent);</span>
<span class="nc" id="L305">        setIntent(intent);</span>
<span class="nc" id="L306">        setCurrentTab();</span>

<span class="nc" id="L308">        int index = mViewPager.getCurrentItem();</span>
<span class="nc" id="L309">        Fragment fragment = (Fragment) mFragmentPageReferenceMap.get(index);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (fragment != null)</span>
<span class="nc" id="L311">            ((Refreshable)fragment).refresh();</span>

<span class="nc" id="L313">        handleOpenFileIntent(intent);</span>
<span class="nc" id="L314">    }</span>

    /**
     * Sets the current tab in the ViewPager
     */
    public void setCurrentTab(){
<span class="nc" id="L320">        SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L321">        int lastTabIndex = preferences.getInt(LAST_OPEN_TAB_INDEX, INDEX_TOP_LEVEL_ACCOUNTS_FRAGMENT);</span>
<span class="nc" id="L322">        int index = getIntent().getIntExtra(EXTRA_TAB_INDEX, lastTabIndex);</span>
<span class="nc" id="L323">        mViewPager.setCurrentItem(index);</span>
<span class="nc" id="L324">    }</span>

    /**
     * Loads default setting for currency and performs app first-run initialization.
     * &lt;p&gt;Also handles displaying the What's New dialog&lt;/p&gt;
     */
    private void init() {
<span class="nc" id="L331">        PreferenceManager.setDefaultValues(this, BooksDbAdapter.getInstance().getActiveBookUID(),</span>
                Context.MODE_PRIVATE, R.xml.fragment_transaction_preferences, true);

<span class="nc" id="L334">        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L335">        boolean firstRun = prefs.getBoolean(getString(R.string.key_first_run), true);</span>

<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (firstRun){</span>
<span class="nc" id="L338">            startActivity(new Intent(GnuCashApplication.getAppContext(), FirstRunWizardActivity.class));</span>

            //default to using double entry and save the preference explicitly
<span class="nc" id="L341">            prefs.edit().putBoolean(getString(R.string.key_use_double_entry), true).apply();</span>
<span class="nc" id="L342">            finish();</span>
<span class="nc" id="L343">            return;</span>
        }

<span class="nc bnc" id="L346" title="All 2 branches missed.">        if (hasNewFeatures()){</span>
<span class="nc" id="L347">            showWhatsNewDialog(this);</span>
        }
<span class="nc" id="L349">        GnuCashApplication.startScheduledActionExecutionService(this);</span>
<span class="nc" id="L350">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc" id="L354">        super.onDestroy();</span>
<span class="nc" id="L355">        SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L356">        preferences.edit().putInt(LAST_OPEN_TAB_INDEX, mViewPager.getCurrentItem()).apply();</span>
<span class="nc" id="L357">    }</span>

    /**
	 * Checks if the minor version has been increased and displays the What's New dialog box.
	 * This is the minor version as per semantic versioning.
	 * @return &lt;code&gt;true&lt;/code&gt; if the minor version has been increased, &lt;code&gt;false&lt;/code&gt; otherwise.
	 */
	private boolean hasNewFeatures(){
<span class="nc" id="L365">        String minorVersion = getResources().getString(R.string.app_minor_version);</span>
<span class="nc" id="L366">        int currentMinor = Integer.parseInt(minorVersion);</span>

<span class="nc" id="L368">        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L369">        int previousMinor = prefs.getInt(getString(R.string.key_previous_minor_version), 0);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (currentMinor &gt; previousMinor){</span>
<span class="nc" id="L371">            Editor editor = prefs.edit();</span>
<span class="nc" id="L372">            editor.putInt(getString(R.string.key_previous_minor_version), currentMinor);</span>
<span class="nc" id="L373">            editor.apply();</span>
<span class="nc" id="L374">            return true;</span>
        }
<span class="nc" id="L376">        return false;</span>
	}
	
	/**
	 * Show dialog with new features for this version
	 */
	public static AlertDialog showWhatsNewDialog(Context context){
<span class="nc" id="L383">        Resources resources = context.getResources();</span>
<span class="nc" id="L384">        StringBuilder releaseTitle = new StringBuilder(resources.getString(R.string.title_whats_new));</span>
        PackageInfo packageInfo;
        try {
<span class="nc" id="L387">            packageInfo = context.getPackageManager().getPackageInfo(context.getPackageName(), 0);</span>
<span class="nc" id="L388">            releaseTitle.append(&quot; - v&quot;).append(packageInfo.versionName);</span>
<span class="nc" id="L389">        } catch (NameNotFoundException e) {</span>
<span class="nc" id="L390">            Crashlytics.logException(e);</span>
<span class="nc" id="L391">            Log.e(LOG_TAG, &quot;Error displaying 'Whats new' dialog&quot;);</span>
<span class="nc" id="L392">        }</span>

<span class="nc" id="L394">        return new AlertDialog.Builder(context)</span>
<span class="nc" id="L395">		.setTitle(releaseTitle.toString())</span>
<span class="nc" id="L396">		.setMessage(R.string.whats_new)</span>
<span class="nc" id="L397">		.setPositiveButton(R.string.label_dismiss, new DialogInterface.OnClickListener() {</span>
			
			@Override
			public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L401">				dialog.dismiss();</span>
<span class="nc" id="L402">			}</span>
<span class="nc" id="L403">		}).show();</span>
	}

    /**
     * Displays the dialog for exporting transactions
     */
    public static void openExportFragment(AppCompatActivity activity) {
<span class="nc" id="L410">        Intent intent = new Intent(activity, FormActivity.class);</span>
<span class="nc" id="L411">        intent.putExtra(UxArgument.FORM_TYPE, FormActivity.FormType.EXPORT.name());</span>
<span class="nc" id="L412">        activity.startActivity(intent);</span>
<span class="nc" id="L413">    }</span>

    @Override
	public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L417">		MenuInflater inflater = getMenuInflater();</span>
<span class="nc" id="L418">		inflater.inflate(R.menu.global_actions, menu);</span>
<span class="nc" id="L419">		return true;</span>
	}
	
	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">		switch (item.getItemId()) {</span>
            case android.R.id.home:
<span class="nc" id="L426">                return super.onOptionsItemSelected(item);</span>

		default:
<span class="nc" id="L429">			return false;</span>
		}
	}

    /**
     * Creates default accounts with the specified currency code.
     * If the currency parameter is null, then locale currency will be used if available
     *
     * @param currencyCode Currency code to assign to the imported accounts
     * @param activity Activity for providing context and displaying dialogs
     */
    public static void createDefaultAccounts(final String currencyCode, final Activity activity) {
<span class="nc" id="L441">        TaskDelegate delegate = null;</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (currencyCode != null) {</span>
<span class="nc" id="L443">            delegate = new TaskDelegate() {</span>
                @Override
                public void onTaskComplete() {
<span class="nc" id="L446">                    AccountsDbAdapter.getInstance().updateAllAccounts(DatabaseSchema.AccountEntry.COLUMN_CURRENCY, currencyCode);</span>
<span class="nc" id="L447">                    GnuCashApplication.setDefaultCurrencyCode(currencyCode);</span>
<span class="nc" id="L448">                }</span>
            };
        }

<span class="nc" id="L452">        Uri uri = Uri.parse(&quot;android.resource://&quot; + BuildConfig.APPLICATION_ID + &quot;/&quot; + R.raw.default_accounts);</span>
<span class="nc" id="L453">        new ImportAsyncTask(activity, delegate).execute(uri);</span>
<span class="nc" id="L454">    }</span>

    /**
     * Starts Intent chooser for selecting a GnuCash accounts file to import.
     * &lt;p&gt;The {@code activity} is responsible for the actual import of the file and can do so by calling {@link #importXmlFileFromIntent(Activity, Intent, TaskDelegate)}&lt;br&gt;
     * The calling class should respond to the request code {@link AccountsActivity#REQUEST_PICK_ACCOUNTS_FILE} in its {@link #onActivityResult(int, int, Intent)} method&lt;/p&gt;
     * @param activity Activity starting the request and will also handle the response
     * @see #importXmlFileFromIntent(Activity, Intent, TaskDelegate)
     */
    public static void startXmlFileChooser(Activity activity) {
<span class="nc" id="L464">        Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);</span>
<span class="nc" id="L465">        pickIntent.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L466">        pickIntent.setType(&quot;*/*&quot;);</span>
<span class="nc" id="L467">        Intent chooser = Intent.createChooser(pickIntent, &quot;Select GnuCash account file&quot;); //todo internationalize string</span>

        try {
<span class="nc" id="L470">            activity.startActivityForResult(chooser, REQUEST_PICK_ACCOUNTS_FILE);</span>
<span class="nc" id="L471">        } catch (ActivityNotFoundException ex){</span>
<span class="nc" id="L472">            Crashlytics.log(&quot;No file manager for selecting files available&quot;);</span>
<span class="nc" id="L473">            Crashlytics.logException(ex);</span>
<span class="nc" id="L474">            Toast.makeText(activity, R.string.toast_install_file_manager, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L475">        }</span>
<span class="nc" id="L476">    }</span>

    /**
     * Overloaded method.
     * Starts chooser for selecting a GnuCash account file to import
     * @param fragment Fragment creating the chooser and which will also handle the result
     * @see #startXmlFileChooser(Activity)
     */
    public static void startXmlFileChooser(Fragment fragment) {
<span class="nc" id="L485">        Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);</span>
<span class="nc" id="L486">        pickIntent.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L487">        pickIntent.setType(&quot;*/*&quot;);</span>
<span class="nc" id="L488">        Intent chooser = Intent.createChooser(pickIntent, &quot;Select GnuCash account file&quot;); //todo internationalize string</span>

        try {
<span class="nc" id="L491">            fragment.startActivityForResult(chooser, REQUEST_PICK_ACCOUNTS_FILE);</span>
<span class="nc" id="L492">        } catch (ActivityNotFoundException ex){</span>
<span class="nc" id="L493">            Crashlytics.log(&quot;No file manager for selecting files available&quot;);</span>
<span class="nc" id="L494">            Crashlytics.logException(ex);</span>
<span class="nc" id="L495">            Toast.makeText(fragment.getActivity(), R.string.toast_install_file_manager, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L496">        }</span>
<span class="nc" id="L497">    }</span>

    /**
     * Reads and XML file from an intent and imports it into the database
     * &lt;p&gt;This method is usually called in response to {@link AccountsActivity#startXmlFileChooser(Activity)}&lt;/p&gt;
     * @param context Activity context
     * @param data Intent data containing the XML uri
     * @param onFinishTask Task to be executed when import is complete
     */
    public static void importXmlFileFromIntent(Activity context, Intent data, TaskDelegate onFinishTask) {
<span class="nc" id="L507">        GncXmlExporter.createBackup();</span>
<span class="nc" id="L508">        new ImportAsyncTask(context, onFinishTask).execute(data.getData());</span>
<span class="nc" id="L509">    }</span>

    /**
     * Starts the AccountsActivity and clears the activity stack
     * @param context Application context
     */
    public static void start(Context context){
<span class="nc" id="L516">        Intent accountsActivityIntent = new Intent(context, AccountsActivity.class);</span>
<span class="nc" id="L517">        accountsActivityIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
<span class="nc" id="L518">        accountsActivityIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L519">        context.startActivity(accountsActivityIntent);</span>
<span class="nc" id="L520">    }</span>

    @Override
	public void accountSelected(String accountUID) {
<span class="nc" id="L524">		Intent intent = new Intent(this, TransactionsActivity.class);</span>
<span class="nc" id="L525">		intent.setAction(Intent.ACTION_VIEW);</span>
<span class="nc" id="L526">		intent.putExtra(UxArgument.SELECTED_ACCOUNT_UID, accountUID);</span>

<span class="nc" id="L528">		startActivity(intent);</span>
<span class="nc" id="L529">	}</span>
	
	/**
	 * Removes the flag indicating that the app is being run for the first time. 
	 * This is called every time the app is started because the next time won't be the first time
	 */
	public static void removeFirstRunFlag(){
<span class="nc" id="L536">        Context context = GnuCashApplication.getAppContext();</span>
<span class="nc" id="L537">		Editor editor = PreferenceManager.getDefaultSharedPreferences(context).edit();</span>
<span class="nc" id="L538">		editor.putBoolean(context.getString(R.string.key_first_run), false);</span>
<span class="nc" id="L539">		editor.commit();</span>
<span class="nc" id="L540">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>
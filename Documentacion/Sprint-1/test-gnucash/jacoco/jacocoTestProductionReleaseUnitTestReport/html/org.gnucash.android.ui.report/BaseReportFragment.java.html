<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseReportFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.gnucash.android.ui.report</a> &gt; <span class="el_source">BaseReportFragment.java</span></div><h1>BaseReportFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2015 Ngewi Fet &lt;ngewif@gmail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.gnucash.android.ui.report;

import android.content.Context;
import android.graphics.Color;
import android.os.AsyncTask;
import android.os.Bundle;
import android.support.annotation.LayoutRes;
import android.support.annotation.Nullable;
import android.support.annotation.StringRes;
import android.support.v4.app.Fragment;
import android.support.v7.app.ActionBar;
import android.support.v7.app.AppCompatActivity;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;

import com.github.mikephil.charting.data.Entry;
import com.github.mikephil.charting.highlight.Highlight;
import com.github.mikephil.charting.listener.OnChartValueSelectedListener;

import org.gnucash.android.R;
import org.gnucash.android.app.GnuCashApplication;
import org.gnucash.android.db.adapter.CommoditiesDbAdapter;
import org.gnucash.android.model.AccountType;
import org.gnucash.android.model.Commodity;
import org.gnucash.android.ui.common.Refreshable;
import org.joda.time.LocalDateTime;
import org.joda.time.Months;
import org.joda.time.Years;

import butterknife.BindView;
import butterknife.ButterKnife;

/**
 * Base class for report fragments.
 * &lt;p&gt;All report fragments should extend this class. At the minimum, reports must implement
 * {@link #getLayoutResource()}, {@link #getReportType()}, {@link #generateReport()}, {@link #displayReport()} and {@link #getTitle()}&lt;/p&gt;
 * &lt;p&gt;Implementing classes should create their own XML layouts and provide it in {@link #getLayoutResource()}.
 * Then annotate any views in the resource using {@code @Bind} annotation from ButterKnife library.
 * This base activity will automatically call {@link ButterKnife#bind(View)} for the layout.
 * &lt;/p&gt;
 * &lt;p&gt;Any custom information to be initialized for the report should be done in {@link #onActivityCreated(Bundle)} in implementing classes.
 * The report is then generated in {@link #onStart()}
 * &lt;/p&gt;
 * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
 */
<span class="nc bnc" id="L65" title="All 2 branches missed.">public abstract class BaseReportFragment extends Fragment implements</span>
        OnChartValueSelectedListener, ReportOptionsListener, Refreshable {

    /**
     * Color for chart with no data
     */
    public static final int NO_DATA_COLOR = Color.LTGRAY;

<span class="nc" id="L73">    protected static String TAG = &quot;BaseReportFragment&quot;;</span>

    /**
     * Reporting period start time
     */
<span class="nc" id="L78">    protected long mReportPeriodStart = -1;</span>
    /**
     * Reporting period end time
     */
<span class="nc" id="L82">    protected long mReportPeriodEnd = -1;</span>

    /**
     * Account type for which to display reports
     */
    protected AccountType mAccountType;

    /**
     * Commodity for which to display reports
     */
    protected Commodity mCommodity;

    /**
     * Intervals in which to group reports
     */
<span class="nc" id="L97">    protected ReportsActivity.GroupInterval mGroupInterval = ReportsActivity.GroupInterval.MONTH;</span>

    /**
     * Pattern to use to display selected chart values
     */
    public static final String SELECTED_VALUE_PATTERN = &quot;%s - %.2f (%.2f %%)&quot;;

    protected ReportsActivity mReportsActivity;

    @Nullable @BindView(R.id.selected_chart_slice) protected TextView mSelectedValueTextView;

    private AsyncTask&lt;Void, Void, Void&gt; mReportGenerator;

    /**
     * Return the title of this report
     * @return Title string identifier
     */
    public abstract @StringRes int getTitle();

    /**
     * Returns the layout resource to use for this report
     * @return Layout resource identifier
     */
    public abstract @LayoutRes int getLayoutResource();

    /**
     * Returns what kind of report this is
     * @return Type of report
     */
    public abstract ReportType getReportType();

    /**
     * Return {@code true} if this report fragment requires account type options.
     * &lt;p&gt;Sub-classes should implement this method. The base implementation returns {@code true}&lt;/p&gt;
     * @return {@code true} if the fragment makes use of account type options, {@code false} otherwise
     */
    public boolean requiresAccountTypeOptions(){
<span class="nc" id="L134">        return true;</span>
    }

    /**
     * Return {@code true} if this report fragment requires time range options.
     * &lt;p&gt;Base implementation returns true&lt;/p&gt;
     * @return {@code true} if the report fragment requires time range options, {@code false} otherwise
     */
    public boolean requiresTimeRangeOptions(){
<span class="nc" id="L143">        return true;</span>
    }

    /**
     * Generates the data for the report
     * &lt;p&gt;This method should not call any methods which modify the UI as it will be run in a background thread
     * &lt;br&gt;Put any code to update the UI in {@link #displayReport()}
     * &lt;/p&gt;
     */
    protected abstract void generateReport();

    /**
     * Update the view after the report chart has been generated &lt;br/&gt;
     * Sub-classes should call to the base method
     */
    protected abstract void displayReport();

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L162">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L163">        TAG = this.getClass().getSimpleName();</span>
<span class="nc" id="L164">    }</span>

    @Nullable
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L169">        View view = inflater.inflate(getLayoutResource(), container, false);</span>
<span class="nc" id="L170">        ButterKnife.bind(this, view);</span>
<span class="nc" id="L171">        return view;</span>
    }

    @Override
    public void onActivityCreated(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L176">        super.onActivityCreated(savedInstanceState);</span>

<span class="nc" id="L178">        ActionBar actionBar = ((AppCompatActivity)getActivity()).getSupportActionBar();</span>
<span class="nc bnc" id="L179" title="All 4 branches missed.">        assert actionBar != null;</span>
<span class="nc" id="L180">        actionBar.setTitle(getTitle());</span>

<span class="nc" id="L182">        setHasOptionsMenu(true);</span>
<span class="nc" id="L183">        mCommodity = CommoditiesDbAdapter.getInstance()</span>
<span class="nc" id="L184">                    .getCommodity(GnuCashApplication.getDefaultCurrencyCode());</span>

<span class="nc" id="L186">        ReportsActivity reportsActivity = (ReportsActivity) getActivity();</span>
<span class="nc" id="L187">        mReportPeriodStart = reportsActivity.getReportPeriodStart();</span>
<span class="nc" id="L188">        mReportPeriodEnd = reportsActivity.getReportPeriodEnd();</span>
<span class="nc" id="L189">        mAccountType = reportsActivity.getAccountType();</span>
<span class="nc" id="L190">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L194">        super.onStart();</span>
<span class="nc" id="L195">        refresh();</span>
<span class="nc" id="L196">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L200">        super.onResume();</span>
<span class="nc" id="L201">        mReportsActivity.setAppBarColor(getReportType().getTitleColor());</span>
<span class="nc" id="L202">        mReportsActivity.toggleToolbarTitleVisibility();</span>
<span class="nc" id="L203">        toggleBaseReportingOptionsVisibility();</span>
<span class="nc" id="L204">    }</span>

    @Override
    public void onAttach(Context context) {
<span class="nc" id="L208">        super.onAttach(context);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!(getActivity() instanceof ReportsActivity))</span>
<span class="nc" id="L210">            throw new RuntimeException(&quot;Report fragments can only be used with the ReportsActivity&quot;);</span>
        else
<span class="nc" id="L212">            mReportsActivity = (ReportsActivity) getActivity();</span>
<span class="nc" id="L213">    }</span>

    @Override
    public void onDetach() {
<span class="nc" id="L217">        super.onDetach();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (mReportGenerator != null)</span>
<span class="nc" id="L219">            mReportGenerator.cancel(true);</span>
<span class="nc" id="L220">    }</span>

    private void toggleBaseReportingOptionsVisibility() {
<span class="nc" id="L223">        View timeRangeLayout = mReportsActivity.findViewById(R.id.time_range_layout);</span>
<span class="nc" id="L224">        View dateRangeDivider = mReportsActivity.findViewById(R.id.date_range_divider);</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">        if (timeRangeLayout != null &amp;&amp; dateRangeDivider != null) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            int visibility = requiresTimeRangeOptions() ? View.VISIBLE : View.GONE;</span>
<span class="nc" id="L227">            timeRangeLayout.setVisibility(visibility);</span>
<span class="nc" id="L228">            dateRangeDivider.setVisibility(visibility);</span>
        }

<span class="nc" id="L231">        View accountTypeSpinner = mReportsActivity.findViewById(R.id.report_account_type_spinner);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">        int visibility = requiresAccountTypeOptions() ? View.VISIBLE : View.GONE;</span>
<span class="nc" id="L233">        accountTypeSpinner.setVisibility(visibility);</span>
<span class="nc" id="L234">    }</span>


    /**
     * Calculates difference between two date values accordingly to {@code mGroupInterval}
     * @param start start date
     * @param end end date
     * @return difference between two dates or {@code -1}
     */
    protected int getDateDiff(LocalDateTime start, LocalDateTime end) {
<span class="nc bnc" id="L244" title="All 4 branches missed.">        switch (mGroupInterval) {</span>
            case QUARTER:
<span class="nc" id="L246">                int y = Years.yearsBetween(start.withDayOfYear(1).withMillisOfDay(0), end.withDayOfYear(1).withMillisOfDay(0)).getYears();</span>
<span class="nc" id="L247">                return getQuarter(end) - getQuarter(start) + y * 4;</span>
            case MONTH:
<span class="nc" id="L249">                return Months.monthsBetween(start.withDayOfMonth(1).withMillisOfDay(0), end.withDayOfMonth(1).withMillisOfDay(0)).getMonths();</span>
            case YEAR:
<span class="nc" id="L251">                return Years.yearsBetween(start.withDayOfYear(1).withMillisOfDay(0), end.withDayOfYear(1).withMillisOfDay(0)).getYears();</span>
            default:
<span class="nc" id="L253">                return -1;</span>
        }
    }


    /**
     * Returns a quarter of the specified date
     * @param date date
     * @return a quarter
     */
    protected int getQuarter(LocalDateTime date) {
<span class="nc" id="L264">        return (date.getMonthOfYear() - 1) / 3 + 1;</span>
    }


    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L270">        inflater.inflate(R.menu.chart_actions, menu);</span>
<span class="nc" id="L271">    }</span>

    @Override
    public void refresh() {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (mReportGenerator != null)</span>
<span class="nc" id="L276">            mReportGenerator.cancel(true);</span>

<span class="nc" id="L278">        mReportGenerator = new AsyncTask&lt;Void, Void, Void&gt;() {</span>

            @Override
            protected void onPreExecute() {
<span class="nc" id="L282">                mReportsActivity.getProgressBar().setVisibility(View.VISIBLE);</span>
<span class="nc" id="L283">            }</span>

            @Override
            protected Void doInBackground(Void... params) {
<span class="nc" id="L287">                generateReport();</span>
<span class="nc" id="L288">                return null;</span>
            }

            @Override
            protected void onPostExecute(Void aVoid) {
<span class="nc" id="L293">                displayReport();</span>
<span class="nc" id="L294">                mReportsActivity.getProgressBar().setVisibility(View.GONE);</span>
<span class="nc" id="L295">            }</span>
        };
<span class="nc" id="L297">        mReportGenerator.execute();</span>
<span class="nc" id="L298">    }</span>

    /**
     * Charts do not support account specific refreshes in general.
     * So we provide a base implementation which just calls {@link #refresh()}
     *
     * @param uid GUID of relevant item to be refreshed
     */
    @Override
    public void refresh(String uid) {
<span class="nc" id="L308">        refresh();</span>
<span class="nc" id="L309">    }</span>

    @Override
    public void onGroupingUpdated(ReportsActivity.GroupInterval groupInterval) {
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (mGroupInterval != groupInterval) {</span>
<span class="nc" id="L314">            mGroupInterval = groupInterval;</span>
<span class="nc" id="L315">            refresh();</span>
        }
<span class="nc" id="L317">    }</span>

    @Override
    public void onTimeRangeUpdated(long start, long end) {
<span class="nc bnc" id="L321" title="All 4 branches missed.">        if (mReportPeriodStart != start || mReportPeriodEnd != end) {</span>
<span class="nc" id="L322">            mReportPeriodStart = start;</span>
<span class="nc" id="L323">            mReportPeriodEnd = end;</span>
<span class="nc" id="L324">            refresh();</span>
        }
<span class="nc" id="L326">    }</span>

    @Override
    public void onAccountTypeUpdated(AccountType accountType) {
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (mAccountType != accountType) {</span>
<span class="nc" id="L331">            mAccountType = accountType;</span>
<span class="nc" id="L332">            refresh();</span>
        }
<span class="nc" id="L334">    }</span>

    @Override
    public void onValueSelected(Entry e, int dataSetIndex, Highlight h) {
        //nothing to see here, move along
<span class="nc" id="L339">    }</span>

    @Override
    public void onNothingSelected() {
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (mSelectedValueTextView != null)</span>
<span class="nc" id="L344">            mSelectedValueTextView.setText(R.string.select_chart_to_view_details);</span>
<span class="nc" id="L345">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>
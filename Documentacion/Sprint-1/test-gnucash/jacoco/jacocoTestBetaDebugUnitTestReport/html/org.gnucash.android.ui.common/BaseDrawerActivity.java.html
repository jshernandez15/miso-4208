<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseDrawerActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.gnucash.android.ui.common</a> &gt; <span class="el_source">BaseDrawerActivity.java</span></div><h1>BaseDrawerActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2015 Ngewi Fet &lt;ngewif@gmail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.gnucash.android.ui.common;

import android.app.Activity;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.database.Cursor;
import android.graphics.Color;
import android.graphics.PorterDuff;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.annotation.LayoutRes;
import android.support.annotation.StringRes;
import android.support.design.widget.NavigationView;
import android.support.v4.widget.DrawerLayout;
import android.support.v7.app.ActionBar;
import android.support.v7.app.ActionBarDrawerToggle;
import android.support.v7.widget.PopupMenu;
import android.support.v7.widget.Toolbar;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.ProgressBar;
import android.widget.TextView;

import com.uservoice.uservoicesdk.UserVoice;

import org.gnucash.android.R;
import org.gnucash.android.app.GnuCashApplication;
import org.gnucash.android.db.DatabaseSchema;
import org.gnucash.android.db.adapter.BooksDbAdapter;
import org.gnucash.android.ui.account.AccountsActivity;
import org.gnucash.android.ui.passcode.PasscodeLockActivity;
import org.gnucash.android.ui.report.ReportsActivity;
import org.gnucash.android.ui.settings.PreferenceActivity;
import org.gnucash.android.ui.transaction.ScheduledActionsActivity;
import org.gnucash.android.util.BookUtils;

import butterknife.BindView;
import butterknife.ButterKnife;


/**
 * Base activity implementing the navigation drawer, to be extended by all activities requiring one.
 * &lt;p&gt;
 *     Each activity inheriting from this class has an indeterminate progress bar at the top,
 *     (above the action bar) which can be used to display busy operations. See {@link #getProgressBar()}
 * &lt;/p&gt;
 *
 * &lt;p&gt;Sub-classes should simply provide their layout using {@link #getContentView()} and then annotate
 * any variables they wish to use with {@link ButterKnife#bind(Activity)} annotations. The view
 * binding will be done in this base abstract class.&lt;br&gt;
 * The activity layout of the subclass is expected to contain {@code DrawerLayout} and
 * a {@code NavigationView}.&lt;br&gt;
 * Sub-class should also consider using the {@code toolbar.xml} or {@code toolbar_with_spinner.xml}
 * for the action bar in their XML layout. Otherwise provide another which contains widgets for the
 * toolbar and progress indicator with the IDs {@code R.id.toolbar} and {@code R.id.progress_indicator} respectively.
 * &lt;/p&gt;
 * @author Ngewi Fet &lt;ngewif@gmail.com&gt;
 */
<span class="nc" id="L76">public abstract class BaseDrawerActivity extends PasscodeLockActivity implements</span>
    PopupMenu.OnMenuItemClickListener {

    public static final int ID_MANAGE_BOOKS = 0xB00C;
    @BindView(R.id.drawer_layout) DrawerLayout mDrawerLayout;
    @BindView(R.id.nav_view) NavigationView mNavigationView;
    @BindView(R.id.toolbar) Toolbar mToolbar;
    @BindView(R.id.toolbar_progress) ProgressBar mToolbarProgress;
    protected TextView mBookNameTextView;

    protected ActionBarDrawerToggle mDrawerToggle;

    public static final int REQUEST_OPEN_DOCUMENT = 0x20;

<span class="nc" id="L90">    private class DrawerItemClickListener implements NavigationView.OnNavigationItemSelectedListener {</span>

        @Override
        public boolean onNavigationItemSelected(MenuItem menuItem) {
<span class="nc" id="L94">            onDrawerMenuItemClicked(menuItem.getItemId());</span>
<span class="nc" id="L95">            return true;</span>
        }

    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L102">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L103">        setContentView(getContentView());</span>

        //if a parameter was passed to open an account within a specific book, then switch
<span class="nc" id="L106">        String bookUID = getIntent().getStringExtra(UxArgument.BOOK_UID);</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">        if (bookUID != null &amp;&amp; !bookUID.equals(BooksDbAdapter.getInstance().getActiveBookUID())){</span>
<span class="nc" id="L108">            BookUtils.activateBook(bookUID);</span>
        }

<span class="nc" id="L111">        ButterKnife.bind(this);</span>
<span class="nc" id="L112">        setSupportActionBar(mToolbar);</span>
<span class="nc" id="L113">        final ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (actionBar != null){</span>
<span class="nc" id="L115">            actionBar.setHomeButtonEnabled(true);</span>
<span class="nc" id="L116">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L117">            actionBar.setTitle(getTitleRes());</span>
        }

<span class="nc" id="L120">        mToolbarProgress.getIndeterminateDrawable().setColorFilter(Color.WHITE, PorterDuff.Mode.SRC_IN);</span>

<span class="nc" id="L122">        View headerView = mNavigationView.getHeaderView(0);</span>
<span class="nc" id="L123">        headerView.findViewById(R.id.drawer_title).setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L126">                onClickAppTitle(v);</span>
<span class="nc" id="L127">            }</span>
        });

<span class="nc" id="L130">        mBookNameTextView = (TextView) headerView.findViewById(R.id.book_name);</span>
<span class="nc" id="L131">        mBookNameTextView.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L134">                onClickBook(v);</span>
<span class="nc" id="L135">            }</span>
        });
<span class="nc" id="L137">        updateActiveBookName();</span>
<span class="nc" id="L138">        setUpNavigationDrawer();</span>
<span class="nc" id="L139">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L143">        super.onResume();</span>
<span class="nc" id="L144">        updateActiveBookName();</span>
<span class="nc" id="L145">    }</span>

    /**
     * Return the layout to inflate for this activity
     * @return Layout resource identifier
     */
    public abstract @LayoutRes int getContentView();

    /**
     * Return the title for this activity.
     * This will be displayed in the action bar
     * @return String resource identifier
     */
    public abstract @StringRes int getTitleRes();

    /**
     * Returns the progress bar for the activity.
     * &lt;p&gt;This progress bar is displayed above the toolbar and should be used to show busy status
     * for long operations.&lt;br/&gt;
     * The progress bar visibility is set to {@link View#GONE} by default. Make visible to use &lt;/p&gt;
     * @return Indeterminate progress bar.
     */
    public ProgressBar getProgressBar(){
<span class="nc" id="L168">        return mToolbarProgress;</span>
    }

    /**
     * Sets up the navigation drawer for this activity.
     */
    private void setUpNavigationDrawer() {
<span class="nc" id="L175">        mNavigationView.setNavigationItemSelectedListener(new DrawerItemClickListener());</span>

<span class="nc" id="L177">        mDrawerToggle = new ActionBarDrawerToggle(</span>
                this,                  /* host Activity */
                mDrawerLayout,         /* DrawerLayout object */
                R.string.drawer_open,  /* &quot;open drawer&quot; description */
                R.string.drawer_close  /* &quot;close drawer&quot; description */
<span class="nc" id="L182">        ) {</span>

            /** Called when a drawer has settled in a completely closed state. */
            public void onDrawerClosed(View view) {
<span class="nc" id="L186">                super.onDrawerClosed(view);</span>
<span class="nc" id="L187">            }</span>

            /** Called when a drawer has settled in a completely open state. */
            public void onDrawerOpened(View drawerView) {
<span class="nc" id="L191">                super.onDrawerOpened(drawerView);</span>
<span class="nc" id="L192">            }</span>
        };

<span class="nc" id="L195">        mDrawerLayout.setDrawerListener(mDrawerToggle);</span>
<span class="nc" id="L196">    }</span>

    @Override
    protected void onPostCreate(Bundle savedInstanceState) {
<span class="nc" id="L200">        super.onPostCreate(savedInstanceState);</span>
<span class="nc" id="L201">        mDrawerToggle.syncState();</span>
<span class="nc" id="L202">    }</span>

    @Override
    public void onConfigurationChanged(Configuration newConfig) {
<span class="nc" id="L206">        super.onConfigurationChanged(newConfig);</span>
<span class="nc" id="L207">        mDrawerToggle.onConfigurationChanged(newConfig);</span>
<span class="nc" id="L208">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (item.getItemId() == android.R.id.home){</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (!mDrawerLayout.isDrawerOpen(mNavigationView))</span>
<span class="nc" id="L214">                mDrawerLayout.openDrawer(mNavigationView);</span>
            else
<span class="nc" id="L216">                mDrawerLayout.closeDrawer(mNavigationView);</span>
<span class="nc" id="L217">            return true;</span>
        }

<span class="nc" id="L220">        return super.onOptionsItemSelected(item);</span>
    }

    /**
     * Update the display name of the currently active book
     */
    protected void updateActiveBookName(){
<span class="nc" id="L227">        mBookNameTextView.setText(BooksDbAdapter.getInstance().getActiveBookDisplayName());</span>
<span class="nc" id="L228">    }</span>

    /**
     * Handler for the navigation drawer items
     * */
    protected void onDrawerMenuItemClicked(int itemId) {
<span class="nc bnc" id="L234" title="All 8 branches missed.">        switch (itemId){</span>
            case R.id.nav_item_open: { //Open... files
                //use the storage access framework
<span class="nc" id="L237">                Intent openDocument = new Intent(Intent.ACTION_OPEN_DOCUMENT);</span>
<span class="nc" id="L238">                openDocument.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L239">                openDocument.setType(&quot;text/*|application/*&quot;);</span>
<span class="nc" id="L240">                String[] mimeTypes = {&quot;text/*&quot;, &quot;application/*&quot;};</span>
<span class="nc" id="L241">                openDocument.putExtra(Intent.EXTRA_MIME_TYPES, mimeTypes);</span>
<span class="nc" id="L242">                startActivityForResult(openDocument, REQUEST_OPEN_DOCUMENT);</span>
            }
<span class="nc" id="L244">            break;</span>

            case R.id.nav_item_favorites: { //favorite accounts
<span class="nc" id="L247">                Intent intent = new Intent(this, AccountsActivity.class);</span>
<span class="nc" id="L248">                intent.putExtra(AccountsActivity.EXTRA_TAB_INDEX,</span>
                        AccountsActivity.INDEX_FAVORITE_ACCOUNTS_FRAGMENT);
<span class="nc" id="L250">                intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP|Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L251">                startActivity(intent);</span>
            }
<span class="nc" id="L253">                break;</span>

            case R.id.nav_item_reports: {
<span class="nc" id="L256">                Intent intent = new Intent(this, ReportsActivity.class);</span>
<span class="nc" id="L257">                intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L258">                startActivity(intent);</span>
            }
<span class="nc" id="L260">                break;</span>

/*
            //todo: Re-enable this when Budget UI is complete
            case R.id.nav_item_budgets:
                startActivity(new Intent(this, BudgetsActivity.class));
                break;
*/
            case R.id.nav_item_scheduled_actions: { //show scheduled transactions
<span class="nc" id="L269">                Intent intent = new Intent(this, ScheduledActionsActivity.class);</span>
<span class="nc" id="L270">                intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L271">                startActivity(intent);</span>
            }
<span class="nc" id="L273">                break;</span>

            case R.id.nav_item_export:
<span class="nc" id="L276">                AccountsActivity.openExportFragment(this);</span>
<span class="nc" id="L277">                break;</span>

            case R.id.nav_item_settings: //Settings activity
<span class="nc" id="L280">                startActivity(new Intent(this, PreferenceActivity.class));</span>
<span class="nc" id="L281">                break;</span>

            case R.id.nav_item_help:
<span class="nc" id="L284">                SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L285">                prefs.edit().putBoolean(UxArgument.SKIP_PASSCODE_SCREEN, true).apply();</span>
<span class="nc" id="L286">                UserVoice.launchUserVoice(this);</span>
                break;
        }
<span class="nc" id="L289">        mDrawerLayout.closeDrawer(mNavigationView);</span>
<span class="nc" id="L290">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (resultCode == Activity.RESULT_CANCELED) {</span>
<span class="nc" id="L295">            super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc" id="L296">            return;</span>
        }

<span class="nc bnc" id="L299" title="All 3 branches missed.">        switch (requestCode) {</span>
            case AccountsActivity.REQUEST_PICK_ACCOUNTS_FILE:
<span class="nc" id="L301">                AccountsActivity.importXmlFileFromIntent(this, data, null);</span>
<span class="nc" id="L302">                break;</span>
            case BaseDrawerActivity.REQUEST_OPEN_DOCUMENT: //this uses the Storage Access Framework
<span class="nc" id="L304">                final int takeFlags = data.getFlags()</span>
                        &amp; (Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
<span class="nc" id="L306">                AccountsActivity.importXmlFileFromIntent(this, data, null);</span>
<span class="nc" id="L307">                getContentResolver().takePersistableUriPermission(data.getData(), takeFlags);</span>
<span class="nc" id="L308">                break;</span>
            default:
<span class="nc" id="L310">                super.onActivityResult(requestCode, resultCode, data);</span>
                break;
        }
<span class="nc" id="L313">    }</span>

    @Override
    public boolean onMenuItemClick(MenuItem item) {
<span class="nc" id="L317">        long id = item.getItemId();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (id == ID_MANAGE_BOOKS){</span>
<span class="nc" id="L319">            Intent intent = new Intent(this, PreferenceActivity.class);</span>
<span class="nc" id="L320">            intent.setAction(PreferenceActivity.ACTION_MANAGE_BOOKS);</span>
<span class="nc" id="L321">            startActivity(intent);</span>
<span class="nc" id="L322">            mDrawerLayout.closeDrawer(mNavigationView);</span>
<span class="nc" id="L323">            return true;</span>
        }
<span class="nc" id="L325">        BooksDbAdapter booksDbAdapter = BooksDbAdapter.getInstance();</span>
<span class="nc" id="L326">        String bookUID = booksDbAdapter.getUID(id);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (!bookUID.equals(booksDbAdapter.getActiveBookUID())){</span>
<span class="nc" id="L328">            BookUtils.loadBook(bookUID);</span>
<span class="nc" id="L329">            finish();</span>
        }
<span class="nc" id="L331">        AccountsActivity.start(GnuCashApplication.getAppContext());</span>
<span class="nc" id="L332">        return true;</span>
    }

    public void onClickAppTitle(View view){
<span class="nc" id="L336">        mDrawerLayout.closeDrawer(mNavigationView);</span>
<span class="nc" id="L337">        AccountsActivity.start(this);</span>
<span class="nc" id="L338">    }</span>

    public void onClickBook(View view){
<span class="nc" id="L341">        PopupMenu popup = new PopupMenu(this, view);</span>
<span class="nc" id="L342">        popup.setOnMenuItemClickListener(this);</span>

<span class="nc" id="L344">        Menu menu = popup.getMenu();</span>
<span class="nc" id="L345">        int maxRecent = 0;</span>
<span class="nc" id="L346">        Cursor cursor = BooksDbAdapter.getInstance().fetchAllRecords(null, null,</span>
                DatabaseSchema.BookEntry.COLUMN_MODIFIED_AT + &quot; DESC&quot;);
<span class="nc bnc" id="L348" title="All 4 branches missed.">        while (cursor.moveToNext() &amp;&amp; maxRecent++ &lt; 5) {</span>
<span class="nc" id="L349">            long id = cursor.getLong(cursor.getColumnIndexOrThrow(DatabaseSchema.BookEntry._ID));</span>
<span class="nc" id="L350">            String name = cursor.getString(cursor.getColumnIndexOrThrow(DatabaseSchema.BookEntry.COLUMN_DISPLAY_NAME));</span>
<span class="nc" id="L351">            menu.add(0, (int)id, maxRecent, name);</span>
<span class="nc" id="L352">        }</span>
<span class="nc" id="L353">        menu.add(0, ID_MANAGE_BOOKS, maxRecent, R.string.menu_manage_books);</span>

<span class="nc" id="L355">        popup.show();</span>
<span class="nc" id="L356">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>